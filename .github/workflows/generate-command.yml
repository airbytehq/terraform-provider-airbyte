# Speakeasy SDK Generation Workflow
#
# This workflow regenerates the Terraform provider code from the Airbyte connector registry using Speakeasy.
# It can either create a PR with the regenerated code (default) or run in dry-run mode for validation.
#
# Generation Process:
# 1. Fetch connector definitions from the Airbyte connector registry (all connectors, Cloud + OSS)
# 2. Generate api_terraform.yaml with connector-specific schemas (using scripts/generate_terraform_spec.py)
# 3. Upload the generated spec as a GitHub artifact for documentation/debugging
# 4. Run Speakeasy to generate the Terraform provider code
# 5. (If not dry_run) Create a PR with the regenerated code
# 6. (If dry_run) Build and verify the generated code compiles
#
# How to use:
# - Go to Actions > Generate > Run workflow
# - Select the branch to run on (usually main)
# - Optionally check "Dry run" to validate generation without creating a PR
#
# For clean regeneration (when API spec has breaking changes):
# 1. First run the "Clean PR Branch" workflow on an existing Speakeasy PR branch
# 2. Then re-run this Generate workflow on main
#
# Note: This workflow calls the Speakeasy CLI directly (instead of using their Docker-based
# reusable workflow) to allow us to control the Go version via setup-go. This is necessary
# because the generated code requires Go 1.24+, but Speakeasy's Docker image uses Go 1.23.
#
# The spec generation logic is ported from:
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/ApiDocumentationGenerator.kt
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/TemplatesForTerraformOpenapiSpec.kt

name: Generate TF Provider (New PR)
# Note: Top-level permissions are intentionally omitted to allow workflow_call
# from pull_request triggers (which have restricted permissions).
# Job-level permissions are used instead.
"on":
    workflow_dispatch:
        inputs:
            dry_run:
                description: Validate generation without creating a PR
                type: boolean
                default: false
            pr:
                description: 'PR number'
                type: string
                required: false
            comment-id:
                description: 'Comment ID (for slash command triggers)'
                type: string
                required: false
    workflow_call:
        inputs:
            dry_run:
                description: Validate generation without creating a PR
                type: boolean
                default: false
jobs:
    generate:
        name: Generate SDK
        runs-on: ubuntu-latest-16core
        timeout-minutes: 90
        # Note: No explicit permissions here to allow workflow_call from
        # pull_request triggers (which have restricted permissions).
        # The workflow uses GITHUB_TOKEN with default permissions, which is
        # sufficient for dry_run mode. For PR creation (non-dry_run), the
        # peter-evans/create-pull-request action uses its own token.
        steps:
            - name: Authenticate as GitHub App
              if: ${{ !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: actions/create-github-app-token@v2
              id: get-app-token
              with:
                  app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
                  private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

            - name: Post or append starting comment
              if: ${{ !inputs.dry_run && github.event.inputs.pr != '' }}
              id: start-comment
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  issue-number: ${{ github.event.inputs.pr }}
                  comment-id: ${{ github.event.inputs.comment-id || '' }}
                  body: |
                      > **Generate SDK Job Info**
                      >
                      > Running Speakeasy SDK generation.

                      > Job started... [Check job output.](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              uses: astral-sh/setup-uv@v5

            - name: Generate Terraform OpenAPI spec
              run: |
                  mkdir -p generated
                  # Generate spec with all connectors (Cloud + OSS-only)
                  # The script handles deduplication: Cloud connectors + OSS connectors not in Cloud
                  uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml

            - name: Upload generated spec as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: api_terraform_spec
                  path: generated/api_terraform.yaml
                  retention-days: 30

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: 'go.mod'
                  cache: true

            - name: Install Speakeasy CLI
              run: |
                  curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                  echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Clean generated code
              run: |
                  rm -rf internal/sdk
                  rm -f internal/provider/destination_*.go
                  rm -f internal/provider/source_*.go
                  rm -rf internal/provider/types/

            - name: Run Speakeasy
              env:
                  SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                      # Dry run: use --skip-compile, we'll build ourselves
                      speakeasy run --skip-compile
                  else
                      # Normal generation with console output
                      speakeasy run --output console
                  fi

            - name: Update dependencies
              if: ${{ inputs.dry_run }}
              run: |
                  go mod tidy

            - name: Build generated code
              if: ${{ inputs.dry_run }}
              run: |
                  go build ./...

            - name: Generation Summary
              run: |
                  echo "=== Generation Summary ==="
                  echo "Source files: $(ls internal/provider/source_*.go 2>/dev/null | wc -l || echo 0)"
                  echo "Destination files: $(ls internal/provider/destination_*.go 2>/dev/null | wc -l || echo 0)"
                  echo "SDK models: $(ls internal/sdk/models/shared/ 2>/dev/null | wc -l || echo 0)"

            - name: Check for changes
              if: ${{ !inputs.dry_run }}
              id: changes
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: ${{ !inputs.dry_run && steps.changes.outputs.has_changes == 'true' }}
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: regenerate SDK with Speakeasy"
                  title: "chore: regenerate SDK with Speakeasy"
                  body: |
                      This PR was automatically generated by the Speakeasy SDK generation workflow.
                      
                      The spec was generated from the Airbyte connector registry with connector-specific schemas.
                      
                      Please review the changes and merge if they look correct.
                  branch: speakeasy-sdk-regen
                  base: main
                  delete-branch: true

            - name: Append success comment
              if: ${{ success() && !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: hooray
                  body: |
                      > SDK generation completed successfully.

            - name: Append failure comment
              if: ${{ failure() && !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: confused
                  body: |
                      > SDK generation failed. Check the [job output](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
