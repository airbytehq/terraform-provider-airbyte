# Speakeasy SDK Generation Workflow
#
# This workflow regenerates the Terraform provider code from the Airbyte connector registry using Speakeasy.
# It can either create a PR with the regenerated code (default) or run in dry-run mode for validation.
#
# Triggers:
# - On push to main: Auto-generates after every merge to ensure provider stays up-to-date (auto-merge enabled)
# - Daily schedule (6 AM UTC): Catches connector registry changes that happen outside of PRs (auto-merge enabled)
# - Manual workflow_dispatch: For on-demand generation
# - workflow_call: For validation from other workflows (e.g., PR checks)
#
# Generation Process:
# 1. Fetch connector definitions from the Airbyte connector registry (Cloud + OSS connectors)
# 2. Generate api_terraform.yaml with connector-specific schemas (using scripts/generate_terraform_spec.py)
# 3. Upload the generated spec as a GitHub artifact for documentation/debugging
# 4. Run Speakeasy to generate the Terraform provider code
# 5. (If not dry_run) Create a PR with the regenerated code (only if there are changes)
# 6. (If dry_run) Build and verify the generated code compiles
#
# How to use:
# - Go to Actions > Generate > Run workflow
# - Select the branch to run on (usually main)
# - Optionally check "Dry run" to validate generation without creating a PR
#
# For clean regeneration (when API spec has breaking changes):
# 1. First run the "Clean PR Branch" workflow on an existing Speakeasy PR branch
# 2. Then re-run this Generate workflow on main
#
# Note: This workflow calls the Speakeasy CLI directly (instead of using their Docker-based
# reusable workflow) to allow us to control the Go version via setup-go. This is necessary
# because the generated code requires Go 1.24+, but Speakeasy's Docker image uses Go 1.23.
#
# The spec generation logic is ported from:
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/ApiDocumentationGenerator.kt
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/TemplatesForTerraformOpenapiSpec.kt

name: Generate TF Provider (New PR)
# Note: Top-level permissions are intentionally omitted to allow workflow_call
# from pull_request triggers (which have restricted permissions).
# Job-level permissions are used instead.
"on":
    # Auto-generate on merge to main to ensure provider stays up-to-date
    push:
        branches:
            - main
    # Daily scheduled generation to catch registry changes
    schedule:
        # Run daily at 6 AM UTC (10 PM PT / 1 AM ET)
        - cron: '0 6 * * *'
    workflow_dispatch:
        inputs:
            dry_run:
                description: Validate generation without creating a PR
                type: boolean
                default: false
            pr:
                description: 'PR number'
                type: string
                required: false
            comment-id:
                description: 'Comment ID (for slash command triggers)'
                type: string
                required: false
    workflow_call:
        inputs:
            dry_run:
                description: Validate generation without creating a PR
                type: boolean
                default: false
concurrency:
    # Push/schedule runs share a group so newer runs cancel stale ones.
    # Other triggers (workflow_dispatch, workflow_call) get unique groups to avoid cancelling each other.
    group: ${{ (github.event_name == 'push' || github.event_name == 'schedule') && 'generate-new-pr' || format('generate-{0}', github.run_id) }}
    cancel-in-progress: true
jobs:
    generate:
        name: Generate SDK
        runs-on: ubuntu-latest-16core
        timeout-minutes: 60
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Authenticate as GitHub App
              if: ${{ !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: actions/create-github-app-token@v2
              id: get-app-token
              with:
                  app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
                  private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

            - name: Post or append starting comment
              if: ${{ !inputs.dry_run && github.event.inputs.pr != '' }}
              id: start-comment
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  issue-number: ${{ github.event.inputs.pr }}
                  comment-id: ${{ github.event.inputs.comment-id || '' }}
                  body: |
                      > **Generate SDK Job Info**
                      >
                      > Running Speakeasy SDK generation.

                      > Job started... [Check job output.](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              uses: astral-sh/setup-uv@v5

            - name: Generate Terraform OpenAPI spec
              run: |
                  mkdir -p generated
                  # Generate spec with both Cloud and OSS connectors
                  # This includes all connectors from both registries for maximum compatibility
                  uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml

            - name: Upload generated spec as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: api_terraform_spec
                  path: generated/api_terraform.yaml
                  retention-days: 30

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: 'go.mod'
                  cache: true

            - name: Install Speakeasy CLI
              run: |
                  curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                  echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Get next version from release drafter
              id: get-version
              uses: aaronsteers/semantic-pr-release-drafter@v1.1.0
              with:
                  dry-run: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Lint OpenAPI spec (fast-fail for circular references)
              env:
                  SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                  echo "Running Speakeasy lint to detect circular references and other issues..."
                  # Run lint and capture output - this is much faster than full generation
                  # and will catch circular reference issues before they cause hangs
                  speakeasy lint openapi -s generated/api_terraform.yaml 2>&1 | tee lint_output.txt
                  
                  # Check for circular reference warnings that don't have x-speakeasy-type-override
                  if grep -i "circular" lint_output.txt | grep -v "x-speakeasy-type-override"; then
                      echo "::error::Circular reference detected without x-speakeasy-type-override annotation!"
                      echo "Add 'x-speakeasy-type-override: any' to schemas with circular references."
                      exit 1
                  fi
                  
                  echo "Lint passed - no unhandled circular references detected."

            - name: Clean generated code
              run: |
                  rm -rf internal/sdk
                  # Delete generated source/destination files but preserve hand-written ones
                  find internal/provider/ -name 'destination_*.go' ! -name '*movestate*' ! -name '*helpers*' -delete
                  find internal/provider/ -name 'source_*.go' ! -name '*movestate*' ! -name '*helpers*' -delete
                  rm -rf internal/provider/types/

            - name: Generate Provider ${{ steps.get-version.outputs.resolved-version }} with Speakeasy
              env:
                  SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                  VERSION="${{ steps.get-version.outputs.resolved-version }}"
                  if [ -z "$VERSION" ]; then
                      echo "::error::Version resolution returned empty. Cannot proceed without an explicit version."
                      exit 1
                  fi
                  echo "Using version from release drafter: $VERSION"
                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                      speakeasy run --skip-compile --set-version="$VERSION"
                  else
                      speakeasy run --output console --set-version="$VERSION"
                  fi

            - name: Update dependencies
              if: ${{ inputs.dry_run }}
              run: |
                  go mod tidy

            - name: Build generated code
              if: ${{ inputs.dry_run }}
              run: |
                  go build ./...

            - name: Upload generated provider code as artifact
              if: ${{ inputs.dry_run }}
              uses: actions/upload-artifact@v4
              with:
                  name: generated_provider_code
                  path: |
                      internal/provider/
                      internal/sdk/
                  retention-days: 7

            - name: Build provider binaries for testing
              if: ${{ inputs.dry_run }}
              run: |
                  mkdir -p dist
                  # Build for Linux amd64 (AI/CI environments)
                  GOOS=linux GOARCH=amd64 go build -o dist/terraform-provider-airbyte_linux_amd64
                  # Build for Mac M-series (Engineers)
                  GOOS=darwin GOARCH=arm64 go build -o dist/terraform-provider-airbyte_darwin_arm64

            - name: Upload provider binaries as artifact
              if: ${{ inputs.dry_run }}
              uses: actions/upload-artifact@v4
              with:
                  name: provider_binaries
                  path: dist/
                  retention-days: 7

            - name: Generation Summary
              run: |
                  echo "=== Generation Summary ==="
                  echo "Source files: $(ls internal/provider/source_*.go 2>/dev/null | wc -l || echo 0)"
                  echo "Destination files: $(ls internal/provider/destination_*.go 2>/dev/null | wc -l || echo 0)"
                  echo "SDK models: $(ls internal/sdk/models/shared/ 2>/dev/null | wc -l || echo 0)"

            - name: Check for changes
              if: ${{ !inputs.dry_run }}
              id: changes
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Authenticate as GitHub App for PR creation
              if: ${{ !inputs.dry_run && steps.changes.outputs.has_changes == 'true' }}
              uses: actions/create-github-app-token@v2
              id: get-pr-token
              with:
                  app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
                  private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

            - name: Create Pull Request
              if: ${{ !inputs.dry_run && steps.changes.outputs.has_changes == 'true' }}
              id: create-pr
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ steps.get-pr-token.outputs.token }}
                  commit-message: "chore: regenerate SDK with Speakeasy"
                  title: "chore: regenerate SDK with Speakeasy"
                  body: |
                      This PR was automatically generated by the Speakeasy SDK generation workflow.
                      
                      The spec was generated from the Airbyte connector registry with connector-specific schemas.
                      
                      Please review the changes and merge if they look correct.
                  branch: speakeasy-sdk-regen
                  base: main
                  delete-branch: true

            - name: Enable auto-merge (new PR only)
              if: |
                  (github.event_name == 'push'
                   || github.event_name == 'schedule'
                  ) && steps.create-pr.outputs.pull-request-operation == 'created'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash

            - name: Append success comment
              if: ${{ success() && !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: hooray
                  body: |
                      > SDK generation completed successfully.

            - name: Append failure comment
              if: ${{ failure() && !inputs.dry_run && github.event.inputs.pr != '' }}
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: confused
                  body: |
                      > SDK generation failed. Check the [job output](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
