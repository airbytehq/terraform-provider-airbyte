# Speakeasy SDK Generation Workflow
#
# This workflow regenerates the Terraform provider code from the Airbyte connector registry using Speakeasy.
# It creates a PR with the regenerated code for review.
#
# Generation Process:
# 1. Fetch connector definitions from the Airbyte connector registry
# 2. Generate api_terraform.yaml with connector-specific schemas (using scripts/generate_terraform_spec.py)
# 3. Upload the generated spec as a GitHub artifact for documentation/debugging
# 4. Run Speakeasy to generate the Terraform provider code
# 5. Create a PR with the regenerated code
#
# How to use:
# - Go to Actions > Generate > Run workflow
# - Select the branch to run on (usually main)
# - Optionally check "Force generation" to regenerate even if no changes detected
# - Optionally check "Cloud only" to only include connectors available in Airbyte Cloud
#
# For clean regeneration (when API spec has breaking changes):
# 1. First run the "Clean PR Branch" workflow on an existing Speakeasy PR branch
# 2. Then re-run this Generate workflow on main with force=true
#
# Note: This workflow calls the Speakeasy CLI directly (instead of using their Docker-based
# reusable workflow) to allow us to control the Go version via setup-go. This is necessary
# because the generated code requires Go 1.24+, but Speakeasy's Docker image uses Go 1.23.
#
# The spec generation logic is ported from:
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/ApiDocumentationGenerator.kt
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/TemplatesForTerraformOpenapiSpec.kt

name: Generate TF Provider (New PR)
permissions:
    checks: write
    contents: write
    pull-requests: write
    statuses: write
"on":
    workflow_dispatch:
        inputs:
            force:
                description: Force generation of SDKs
                type: boolean
                default: false
            cloud_only:
                description: Only include connectors available in Airbyte Cloud
                type: boolean
                default: true
            pr:
                description: 'PR number'
                type: string
                required: false
            comment-id:
                description: 'Comment ID (for slash command triggers)'
                type: string
                required: false
env:
    GO_VERSION: "1.24"
jobs:
    generate:
        name: Generate SDK
        runs-on: ubuntu-latest
        steps:
            - name: Authenticate as GitHub App
              if: github.event.inputs.pr
              uses: actions/create-github-app-token@v2
              id: get-app-token
              with:
                  app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
                  private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

            - name: Post or append starting comment
              if: github.event.inputs.pr
              id: start-comment
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  issue-number: ${{ github.event.inputs.pr }}
                  comment-id: ${{ github.event.inputs.comment-id || '' }}
                  body: |
                      > **Generate SDK Job Info**
                      >
                      > Running Speakeasy SDK generation (force=${{ github.event.inputs.force || 'false' }}).

                      > Job started... [Check job output.](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              uses: astral-sh/setup-uv@v5

            - name: Generate Terraform OpenAPI spec
              run: |
                  mkdir -p generated
                  if [ "${{ github.event.inputs.cloud_only }}" = "true" ]; then
                      uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml --cloud-only
                  else
                      uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml
                  fi

            - name: Upload generated spec as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: api_terraform_spec
                  path: generated/api_terraform.yaml
                  retention-days: 30

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true

            - name: Install Speakeasy CLI
              run: |
                  curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                  echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Run Speakeasy
              env:
                  SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                  # Use --output console to avoid exceeding GitHub's step summary size limit (1024k)
                  if [ "${{ github.event.inputs.force }}" = "true" ]; then
                      speakeasy run --force --output console
                  else
                      speakeasy run --output console
                  fi

            - name: Check for changes
              id: changes
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: steps.changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: regenerate SDK with Speakeasy"
                  title: "chore: regenerate SDK with Speakeasy"
                  body: |
                      This PR was automatically generated by the Speakeasy SDK generation workflow.
                      
                      The spec was generated from the Airbyte connector registry with connector-specific schemas.
                      
                      Please review the changes and merge if they look correct.
                  branch: speakeasy-sdk-regen
                  base: main
                  delete-branch: true

            - name: Append success comment
              if: success() && github.event.inputs.pr
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: hooray
                  body: |
                      > SDK generation completed successfully.

            - name: Append failure comment
              if: failure() && github.event.inputs.pr
              uses: peter-evans/create-or-update-comment@v5
              with:
                  token: ${{ steps.get-app-token.outputs.token }}
                  comment-id: ${{ steps.start-comment.outputs.comment-id }}
                  reactions: confused
                  body: |
                      > SDK generation failed. Check the [job output](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
