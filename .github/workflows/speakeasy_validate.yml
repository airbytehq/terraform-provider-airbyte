name: Validate Speakeasy Generation

# This workflow validates that the Speakeasy-generated code compiles correctly.
# It runs on every PR push but does NOT create PRs or push changes.
# For actual regeneration, use the manual "Generate" workflow.
#
# The spec generation logic is ported from:
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/ApiDocumentationGenerator.kt
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/TemplatesForTerraformOpenapiSpec.kt

on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'examples/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Generation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

      - name: Generate spec from Airbyte connector registry
        run: |
          mkdir -p generated
          uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml --cloud-only

      - name: Upload spec as artifact
        uses: actions/upload-artifact@v4
        with:
          name: api_terraform_spec
          path: generated/api_terraform.yaml
          retention-days: 5

      - name: Clean generated code
        run: |
          rm -rf internal/sdk
          rm -f internal/provider/destination_*.go
          rm -f internal/provider/source_*.go
          rm -rf internal/provider/types/

      - name: Run Speakeasy Generation
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          speakeasy run --skip-compile

      - name: Update dependencies
        run: |
          go mod tidy

      - name: Build generated code
        run: |
          go build ./...

      - name: Summary
        run: |
          echo "=== Generation Summary ==="
          echo "Source files: $(ls internal/provider/source_*.go 2>/dev/null | wc -l || echo 0)"
          echo "Destination files: $(ls internal/provider/destination_*.go 2>/dev/null | wc -l || echo 0)"
          echo "SDK models: $(ls internal/sdk/models/shared/ 2>/dev/null | wc -l || echo 0)"
