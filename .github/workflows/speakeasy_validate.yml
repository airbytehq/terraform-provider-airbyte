name: Validate Speakeasy Generation

# This workflow validates that the Speakeasy-generated code compiles correctly.
# It runs on every PR push but does NOT create PRs or push changes.
# For actual regeneration, use the manual "Generate" workflow.
#
# The workflow is split into multiple jobs to avoid exceeding GitHub's 1024k step summary limit.
# With ~600 connectors, the Speakeasy CLI produces ~1915k of output in a single job.
#
# TODO: Sources validation is currently disabled because even with just sources (~557 connectors),
# the Speakeasy CLI produces ~1700k of output which exceeds GitHub's 1024k step summary limit.
# To re-enable, we need to either:
# 1. Split sources into multiple batches (e.g., A-M, N-Z)
# 2. Find a way to completely disable Speakeasy's step summary output
# 3. Wait for GitHub to increase the step summary limit
#
# The spec generation logic is ported from:
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/ApiDocumentationGenerator.kt
# - https://github.com/airbytehq/airbyte-platform-internal/blob/master/cloud/public-api-spec-generation/src/main/kotlin/io/airbyte/api/publicapi/gradle/tasks/TemplatesForTerraformOpenapiSpec.kt

on:
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'examples/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Job 1: Generate separate specs for sources and destinations
  generate-specs:
    name: Generate Specs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Generate full spec (for actual generation workflow)
        run: |
          mkdir -p generated
          uv run scripts/generate_terraform_spec.py --output generated/api_terraform.yaml --cloud-only

      - name: Generate destinations-only spec
        run: |
          uv run scripts/generate_terraform_spec.py --output generated/api_terraform_destinations.yaml --cloud-only --type destinations

      - name: Upload specs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api_terraform_specs
          path: generated/
          retention-days: 5

  # TODO: Re-enable sources validation once we solve the step summary size limit issue.
  # Sources alone (~557 connectors) produces ~1700k of output, exceeding GitHub's 1024k limit.
  # Options to fix:
  # 1. Split sources into batches (A-M, N-Z) with a --prefix filter in the spec generator
  # 2. Find a Speakeasy CLI flag to completely disable step summary output
  #
  # run-speakeasy-sources:
  #   name: Run Speakeasy (Sources)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 20
  #   needs: generate-specs
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Download specs
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: api_terraform_specs
  #         path: generated/
  #     - name: Copy sources spec to expected location
  #       run: |
  #         cp generated/api_terraform_sources.yaml generated/api_terraform.yaml
  #     - uses: actions/setup-go@v5
  #       with:
  #         go-version-file: 'go.mod'
  #         cache: true
  #     - name: Install Speakeasy CLI
  #       run: |
  #         curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
  #         echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH
  #     - name: Clean generated code
  #       run: |
  #         rm -rf internal/sdk
  #         rm -f internal/provider/destination_*.go
  #         rm -f internal/provider/source_*.go
  #         rm -rf internal/provider/types/
  #     - name: Run Speakeasy Generation (sources only)
  #       id: generate
  #       continue-on-error: true
  #       env:
  #         SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
  #       run: |
  #         speakeasy run --skip-compile --output console 2>&1 | tee speakeasy_sources_output.txt
  #         echo "speakeasy_exit_code=$?" >> $GITHUB_OUTPUT
  #     - name: Upload sources generated code
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: generated-code-sources
  #         path: |
  #           internal/
  #           go.mod
  #           go.sum
  #           speakeasy_sources_output.txt
  #           .speakeasy/gen.lock
  #         retention-days: 5

  # Job 2: Run Speakeasy for destinations only
  # This job processes ~46 destinations, producing output well under the 1024k limit
  run-speakeasy-destinations:
    name: Run Speakeasy (Destinations)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: generate-specs
    steps:
      - uses: actions/checkout@v4

      - name: Download specs
        uses: actions/download-artifact@v4
        with:
          name: api_terraform_specs
          path: generated/

      - name: Copy destinations spec to expected location
        run: |
          cp generated/api_terraform_destinations.yaml generated/api_terraform.yaml

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

      - name: Clean generated code
        run: |
          rm -rf internal/sdk
          rm -f internal/provider/destination_*.go
          rm -f internal/provider/source_*.go
          rm -rf internal/provider/types/

      - name: Run Speakeasy Generation (destinations only)
        id: generate
        continue-on-error: true
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          speakeasy run --skip-compile --output console 2>&1 | tee speakeasy_destinations_output.txt
          echo "speakeasy_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload destinations generated code
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-code-destinations
          path: |
            internal/
            go.mod
            go.sum
            speakeasy_destinations_output.txt
            .speakeasy/gen.lock
          retention-days: 5

  # Job 3: Build and verify the generated code (destinations only for now)
  # Note: This validates that Speakeasy can process the spec and generate compilable code.
  # Sources validation is temporarily disabled due to GitHub step summary size limits.
  build-and-verify:
    name: Build and Verify
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [run-speakeasy-destinations]
    steps:
      - uses: actions/checkout@v4

      - name: Download destinations generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code-destinations
          path: destinations-gen/

      - name: Copy generated code
        run: |
          # Use destinations generated code
          cp -r destinations-gen/internal/ internal/
          cp destinations-gen/go.mod go.mod 2>/dev/null || true
          cp destinations-gen/go.sum go.sum 2>/dev/null || true
          
          echo "=== Generated code stats ==="
          echo "Destination files:"
          ls internal/provider/destination_*.go 2>/dev/null | wc -l || echo "0"

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Update dependencies
        run: |
          go mod tidy

      - name: Build generated code
        run: |
          go build ./...

      - name: Debug - Inspect generated files
        run: |
          echo "=== List generated SDK models ==="
          ls internal/sdk/models/shared/ 2>/dev/null | head -20 || echo "No SDK models found"
          echo ""
          echo "=== List generated provider files ==="
          ls internal/provider/ 2>/dev/null | head -30 || echo "No provider files found"
          echo ""
          echo "=== Destination count ==="
          ls internal/provider/destination_*.go 2>/dev/null | wc -l || echo "0"
