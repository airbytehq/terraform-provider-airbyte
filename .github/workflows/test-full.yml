# Validate Speakeasy Generation (Dry Run)
#
# This workflow validates that Speakeasy generation can complete successfully.
# It does NOT validate that the generated code matches the committed code (zero-diff).
# It runs on every PR push but does NOT create PRs or push changes.
#
# This workflow calls the main generation workflow with dry_run=true to ensure
# both workflows use the same generation logic.
#
# Note: paths-ignore is NOT used at the workflow level because GitHub treats a
# workflow that never runs as "expected" (pending), which blocks required checks.
# Instead, we filter paths at the job level so skipped jobs report as "skipped"
# (equivalent to "passed" for required checks).

name: Test (Full)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-paths:
    name: Check Changed Paths
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Filter changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            generation:
              - '**'
              - '!README.md'
              - '!docs/**'
              - '!examples/**'
    outputs:
      should_run: ${{ github.event_name == 'workflow_dispatch' || steps.filter.outputs.generation == 'true' }}

  validate:
    name: Validate Generation (Dry Run)
    needs: check-paths
    if: needs.check-paths.outputs.should_run == 'true'
    uses: ./.github/workflows/generate-command.yml
    with:
      dry_run: true
    secrets: inherit
