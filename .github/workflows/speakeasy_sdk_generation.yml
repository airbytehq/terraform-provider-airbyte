name: Generate
permissions:
    checks: write
    contents: write
    pull-requests: write
    statuses: write
"on":
    workflow_dispatch:
        inputs:
            force:
                description: Force generation of SDKs
                type: boolean
                default: false
            clean_before_generate:
                description: Delete all generated files before regeneration (use for major API spec changes)
                type: boolean
                default: false
jobs:
    # Clean regeneration job - runs when clean_before_generate is true
    # Does everything in one job to avoid intermediate commits that break git history
    clean-and-generate:
        runs-on: ubuntu-latest
        if: ${{ inputs.clean_before_generate == true }}
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - uses: actions/setup-go@v5
              with:
                go-version-file: 'go.mod'
                cache: true

            - name: Install Speakeasy CLI
              run: |
                curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Delete all generated code
              run: |
                # Delete ALL generated code to force fully clean regeneration
                # The upstream API spec changed from per-connector types to generic types
                # We need to remove all stale generated files so Speakeasy can regenerate fresh
                
                echo "=== Removing internal/sdk (SDK models and utils) ==="
                rm -rf internal/sdk
                
                echo "=== Removing generated provider destination resources ==="
                rm -f internal/provider/destination_*.go
                
                echo "=== Removing generated provider source resources ==="
                rm -f internal/provider/source_*.go
                
                echo "=== Removing generated provider types ==="
                rm -rf internal/provider/types/
                
                echo "=== Done. All generated code removed. ==="

            - name: Run Speakeasy Generation
              env:
                SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                speakeasy run

            - name: Update dependencies
              run: |
                go mod tidy

            - name: Build generated code
              run: |
                go build -v ./...

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v7
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                commit-message: "chore: Regenerate SDK with Speakeasy (clean regeneration)"
                title: "chore: Regenerate SDK with Speakeasy"
                body: |
                  This PR was automatically generated by the Speakeasy SDK generation workflow.
                  
                  ## Changes
                  - Regenerated SDK from latest OpenAPI spec
                  - Performed clean regeneration (deleted all stale generated files first)
                  
                  ## Review Checklist
                  - [ ] Verify the generated code compiles
                  - [ ] Check for any breaking changes
                  - [ ] Review the changelog (if applicable)
                branch: speakeasy-sdk-regen-${{ github.run_number }}
                delete-branch: true

    # Normal generation job using Speakeasy's reusable workflow
    # Only runs when clean_before_generate is false (default behavior)
    generate:
        if: ${{ inputs.clean_before_generate != true }}
        uses: speakeasy-api/sdk-generation-action/.github/workflows/workflow-executor.yaml@v15
        with:
            force: ${{ github.event.inputs.force }}
            mode: pr
            speakeasy_version: latest
        secrets:
            github_access_token: ${{ secrets.GITHUB_TOKEN }}
            speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}
