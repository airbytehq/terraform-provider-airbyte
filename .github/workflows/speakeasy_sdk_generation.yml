name: Generate
permissions:
    checks: write
    contents: write
    pull-requests: write
    statuses: write
"on":
    workflow_dispatch:
        inputs:
            force:
                description: Force generation of SDKs
                type: boolean
                default: false
jobs:
    clean-and-generate:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - uses: actions/setup-go@v5
              with:
                go-version-file: 'go.mod'
                cache: true

            - name: Install Speakeasy CLI
              run: |
                curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Clean regeneration - delete ALL generated code
              run: |
                # Delete ALL generated code to force fully clean regeneration
                # The upstream API spec changed from per-connector types to generic types
                # We need to remove all stale generated files so Speakeasy can regenerate fresh
                
                echo "=== Removing internal/sdk (SDK models and utils) ==="
                rm -rf internal/sdk
                
                echo "=== Removing generated provider destination resources ==="
                rm -f internal/provider/destination_*.go
                
                echo "=== Removing generated provider source resources ==="
                rm -f internal/provider/source_*.go
                
                echo "=== Removing generated provider types ==="
                rm -rf internal/provider/types/
                
                echo "=== Done. All generated code removed. ==="

            - name: Run Speakeasy Generation
              env:
                SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                speakeasy run

            - name: Update dependencies
              run: |
                go mod tidy

            - name: Build generated code
              run: |
                go build -v ./...

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v7
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                commit-message: "chore: Regenerate SDK with Speakeasy"
                title: "chore: Regenerate SDK with Speakeasy"
                body: |
                  This PR was automatically generated by the Speakeasy SDK generation workflow.
                  
                  ## Changes
                  - Regenerated SDK from latest OpenAPI spec
                  - Cleaned up stale generated files before regeneration
                  
                  ## Review Checklist
                  - [ ] Verify the generated code compiles
                  - [ ] Check for any breaking changes
                  - [ ] Review the changelog (if applicable)
                branch: speakeasy-sdk-regen-${{ github.run_number }}
                delete-branch: true
