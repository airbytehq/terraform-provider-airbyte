# Speakeasy SDK Generation Workflow
#
# This workflow regenerates the Terraform provider code from the upstream OpenAPI spec using Speakeasy.
# It creates a PR with the regenerated code for review.
#
# How to use:
# - Go to Actions > Generate > Run workflow
# - Select the branch to run on (usually main)
# - Optionally check "Force generation" to regenerate even if no changes detected
#
# For clean regeneration (when API spec has breaking changes):
# 1. First run the "Clean PR Branch" workflow on an existing Speakeasy PR branch
# 2. Then re-run this Generate workflow on main with force=true
#
# Note: This workflow calls the Speakeasy CLI directly (instead of using their Docker-based
# reusable workflow) to allow us to control the Go version via setup-go. This is necessary
# because the generated code requires Go 1.24+, but Speakeasy's Docker image uses Go 1.23.

name: Generate
permissions:
    checks: write
    contents: write
    pull-requests: write
    statuses: write
"on":
    workflow_dispatch:
        inputs:
            force:
                description: Force generation of SDKs
                type: boolean
                default: false
env:
    GO_VERSION: "1.24"
jobs:
    generate:
        name: Generate SDK
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true

            - name: Install Speakeasy CLI
              run: |
                  curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
                  echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH

            - name: Run Speakeasy
              env:
                  SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
              run: |
                  if [ "${{ github.event.inputs.force }}" = "true" ]; then
                      speakeasy run --force
                  else
                      speakeasy run
                  fi

            - name: Check for changes
              id: changes
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: steps.changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: regenerate SDK with Speakeasy"
                  title: "chore: regenerate SDK with Speakeasy"
                  body: |
                      This PR was automatically generated by the Speakeasy SDK generation workflow.
                      
                      Please review the changes and merge if they look correct.
                  branch: speakeasy-sdk-regen
                  base: main
                  delete-branch: true
